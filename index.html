<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>مدیریت مالی محمدرضا</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon.png" onerror="this.style.display='none';">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jalali-moment/3.3.11/jalali-moment.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    html, body { min-height: 100vh; }
    body {
      font-family: 'Tahoma', 'Roboto', sans-serif;
      background-color: #1e1e1e;
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
    }
    .header {
      background-color: #2e7d32;
      color: white;
      padding: 1rem;
      border-radius: 0.5rem 0.5rem 0 0;
      text-align: center;
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      background-color: #333;
      padding: 0.5rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }
    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      color: #bbb;
      transition: color 0.3s;
      user-select: none;
    }
    .tab.active {
      color: #ffd700;
      font-weight: bold;
    }
    .card {
      background: #2c2c2c;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s ease-in;
    }
    .btn {
      background-color: #388e3c;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.3s;
      border: none;
      margin-bottom: 0.2rem;
      font-size: 1rem;
    }
    .btn:hover, .btn:focus { background-color: #256029; }
    .list-item { display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #555; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    canvas { max-width: 100%; }
    .hidden { display: none; }
    .task-input { margin-bottom: 0.5rem; }
    input, select {
      background-color: #3c3c3c;
      color: #e0e0e0;
      border: 1px solid #555;
      border-radius: 0.25rem;
      font-size: 1rem;
      padding: 0.5rem;
      width: 100%;
      box-sizing: border-box;
      outline: none;
      margin-bottom: 0.3rem;
    }
    input:focus { border-color: #ffd700; }
    input[type="number"], input[type="tel"] { direction: ltr; text-align: right; }
    input::placeholder, select::placeholder { color: #888; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 1rem;
    }
    th, td { padding: 0.5rem; text-align: right; border-bottom: 1px solid #555; }
    th { background-color: #2e7d32; color: white; }
    @media (max-width: 600px) {
      .container { padding: 0.5rem; }
      .card { padding: 1rem; }
      .tab { font-size: 0.95rem; min-width: 65px;}
      input, select { font-size: 0.95rem; }
      th, td { font-size: 0.9rem; }
      .btn { font-size: 0.95rem; }
    }
    @media (max-width: 400px) {
      .tab { font-size: 0.8rem; min-width: 60px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="welcomeMessage" class="text-xl font-bold">مدیریت مالی محمدرضا</h1>
      <span id="time" class="text-sm"></span>
    </div>
    <div class="tabs">
      <div class="tab" onclick="showTab('transaction')">ثبت تراکنش</div>
      <div class="tab active" onclick="showTab('dailyReport')">روزانه</div>
      <div class="tab" onclick="showTab('monthlyReport')">ماهانه</div>
      <div class="tab" onclick="showTab('accounting')">حسابداری</div>
      <div class="tab" onclick="showTab('debt')">بدهی</div>
      <div class="tab" onclick="showTab('credit')">طلبکاری</div>
      <div class="tab" onclick="showTab('search')">جستجو</div>
    </div>
    <div id="transaction" class="card tab-content">
      <h2 class="text-lg font-semibold mb-2 flex items-center"><i class="fas fa-calendar-alt mr-2"></i>ثبت تراکنش</h2>
      <div class="date-controls">
        <input type="text" id="date" class="w-full p-2 border rounded text-center" placeholder="تاریخ (1404/04/19)" onchange="updateCustomDate('date')" />
        <button onclick="updateCustomDate('date')" class="btn w-full mt-2">تأیید تاریخ</button>
      </div>
      <div class="mb-2">
        <button onclick="addPartner()" class="btn w-full mb-2">اضافه کردن همکار</button>
        <select id="partner" class="w-full p-2 mb-2 border rounded" required>
          <option value="">انتخاب همکار</option>
          <option value="-1">بدون همکار (۰)</option>
        </select>
      </div>
      <div class="mb-2">
        <button onclick="addItem()" class="btn w-full mb-2">اضافه کردن جنس</button>
        <select id="item" class="w-full p-2 mb-2 border rounded" required>
          <option value="">انتخاب جنس</option>
          <option value="-1">بدون جنس (۰)</option>
        </select>
      </div>
      <div id="taskList" class="mb-2">
        <div class="task-input">
          <input type="text" id="taskDescription0" placeholder="توضیح تراکنش" class="w-full p-2 border rounded mb-1" required />
          <input type="number" id="taskIncome0" placeholder="درآمد (تومان)" class="w-full p-2 border rounded mb-1" required />
          <input type="number" id="taskExpense0" placeholder="هزینه (تومان)" class="w-full p-2 border rounded mb-1" required />
        </div>
      </div>
      <button onclick="addTaskInput()" class="btn w-full mb-2">تراکنش جدید</button>
      <button onclick="saveDay()" class="btn w-full">ثبت همه تراکنش‌ها</button>
    </div>
    <div id="dailyReport" class="card tab-content hidden">
      <h2 class="text-lg font-semibold mb-2 flex items-center"><i class="fas fa-chart-bar mr-2"></i>گزارش روزانه</h2>
      <div class="date-controls">
        <input type="text" id="dailyDate" class="w-full p-2 border rounded text-center" placeholder="تاریخ (1404/04/19)" onchange="updateCustomDate('dailyDate')" />
        <button onclick="updateCustomDate('dailyDate')" class="btn w-full mt-2">تأیید تاریخ</button>
      </div>
      <div id="dailyReportContent"></div>
    </div>
    <div id="monthlyReport" class="card tab-content hidden">
      <h2 class="text-lg font-semibold mb-2 flex items-center"><i class="fas fa-calendar-alt mr-2"></i>گزارش ماهانه</h2>
      <div class="date-controls">
        <input type="text" id="monthlyDate" class="w-full p-2 border rounded text-center" placeholder="ماه (1404/04)" onchange="updateCustomMonth()" />
        <button onclick="updateCustomMonth()" class="btn w-full mt-2">تأیید ماه</button>
      </div>
      <div id="monthlyReportContent"></div>
    </div>
    <div id="accounting" class="card tab-content hidden">
      <h2 class="text-lg font-semibold mb-2 flex items-center"><i class="fas fa-calculator mr-2"></i>گزارش مالی</h2>
      <div class="date-controls">
        <input type="text" id="accountingDate" class="w-full p-2 border rounded text-center" placeholder="سال (1404)" onchange="updateCustomYear()" />
        <button onclick="updateCustomYear()" class="btn w-full mt-2">تأیید سال</button>
      </div>
      <div id="accountingContent"></div>
    </div>
    <div id="debt" class="card tab-content hidden">
      <h2 class="text-lg font-semibold mb-2 flex items-center"><i class="fas fa-money-bill-wave mr-2"></i>بدهی</h2>
      <div id="debtContent"></div>
      <div class="mt-2">
        <input type="text" id="newDebtDescription" placeholder="توضیح بدهی" class="w-full p-2 mb-1 border rounded" />
        <input type="number" id="newDebtAmount" placeholder="مبلغ (تومان)" class="w-full p-2 mb-1 border rounded" />
        <button onclick="addDebt()" class="btn w-full mb-2">اضافه کردن بدهی</button>
        <input type="number" id="settleDebtAmount" placeholder="مبلغ تسویه (تومان)" class="w-full p-2 mb-1 border rounded" />
        <button onclick="settleDebt()" class="btn w-full">تسویه بدهی</button>
      </div>
    </div>
    <div id="credit" class="card tab-content hidden">
      <h2 class="text-lg font-semibold mb-2 flex items-center"><i class="fas fa-hand-holding-usd mr-2"></i>طلبکاری</h2>
      <div id="creditContent"></div>
      <div class="mt-2">
        <input type="text" id="newCreditDescription" placeholder="توضیح طلب" class="w-full p-2 mb-1 border rounded" />
        <input type="number" id="newCreditAmount" placeholder="مبلغ (تومان)" class="w-full p-2 mb-1 border rounded" />
        <button onclick="addCredit()" class="btn w-full mb-2">اضافه کردن طلب</button>
        <input type="number" id="settleCreditAmount" placeholder="مبلغ تسویه (تومان)" class="w-full p-2 mb-1 border rounded" />
        <button onclick="settleCredit()" class="btn w-full">تسویه طلب</button>
      </div>
    </div>
    <div id="search" class="card tab-content hidden">
      <h2 class="text-lg font-semibold mb-2 flex items-center"><i class="fas fa-search mr-2"></i>جستجو</h2>
      <input type="text" id="searchInput" class="w-full p-2 mb-2 border rounded" placeholder="جستجو (توضیح، تاریخ، یا جنس)" oninput="searchTasks()" />
      <div id="searchResults"></div>
    </div>
  </div>
  <script>
    // ===== مقداردهی =====
    let partners = JSON.parse(localStorage.getItem('partners')) || [];
    let items = JSON.parse(localStorage.getItem('items')) || [];
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    let debts = JSON.parse(localStorage.getItem('debts')) || [];
    let credits = JSON.parse(localStorage.getItem('credits')) || [];
    let taskCount = 0;

    // پیام خوش‌آمد
    const welcomes = [
      "خوش اومدی محمدرضا! روز مالی خوبی داشته باش!",
      "محمدرضا، مدیریت مالی رو شروع کن!",
      "خوش اومدی! درآمدت رو ردیابی کن!",
      "محمدرضا، به سوی ثروت قدم بردار!"
    ];
    document.getElementById('welcomeMessage').textContent = welcomes[Math.floor(Math.random() * welcomes.length)];

    // تاریخ و ساعت
    function updateDateTime() {
      let jalaliDate = window.jalaliMoment().format('jYYYY/jMM/jDD');
      let now = new Date();
      let hour = now.getHours().toString().padStart(2, '0');
      let min = now.getMinutes().toString().padStart(2, '0');
      document.getElementById('time').textContent = `${hour}:${min}`;
      if(!dateInput.value) dateInput.value = jalaliDate;
      if(!dailyDateInput.value) dailyDateInput.value = jalaliDate;
      if(!monthlyDateInput.value) monthlyDateInput.value = jalaliDate.slice(0,7);
      if(!accountingDateInput.value) accountingDateInput.value = jalaliDate.slice(0,4);
    }
    setInterval(updateDateTime, 30000); updateDateTime();

    // تب‌بندی
    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.remove('hidden');
      if (tabId === 'dailyReport') showDailyReport();
      else if (tabId === 'monthlyReport') showMonthlyReport();
      else if (tabId === 'accounting') showAccounting();
      else if (tabId === 'debt') showDebt();
      else if (tabId === 'credit') showCredit();
      else if (tabId === 'search') searchTasks();
    }

    // فرم‌های همکار و جنس
    function updatePartnerList() {
      const partnerSelect = document.getElementById('partner');
      partnerSelect.innerHTML = '<option value="">انتخاب همکار</option><option value="-1">بدون همکار (۰)</option>';
      partners.forEach((p, index) => {
        const owed = (p.totalWorkedDays || 0) * p.salary - (p.totalPaid || 0);
        partnerSelect.innerHTML += `<option value="${index}">${p.name} - ${p.salary.toLocaleString()} تومان/روز (بدهی: ${owed.toLocaleString()} تومان)</option>`;
      });
      localStorage.setItem('partners', JSON.stringify(partners));
    }
    function addPartner() {
      const name = prompt('نام همکار را وارد کنید');
      const salary = parseInt(prompt('حقوق روزانه (تومان)')) || 0;
      if (name && salary >= 0) {
        partners.push({ name, salary, totalPaid: 0, totalWorkedDays: 0 });
        updatePartnerList();
      } else {
        alert('لطفاً نام و حقوق معتبر وارد کنید.');
      }
    }
    function updateItemList() {
      const itemSelect = document.getElementById('item');
      itemSelect.innerHTML = '<option value="">انتخاب جنس</option><option value="-1">بدون جنس (۰)</option>';
      items.forEach((i, index) => {
        itemSelect.innerHTML += `<option value="${index}">${i.name} - ${i.price.toLocaleString()} تومان${i.category ? ' ('+i.category+')' : ''}</option>`;
      });
      localStorage.setItem('items', JSON.stringify(items));
    }
    function addItem() {
      const name = prompt('نام جنس را وارد کنید');
      const price = parseInt(prompt('قیمت (تومان)')) || 0;
      const category = prompt('دسته‌بندی (اختیاری)') || '';
      if (name && price >= 0) {
        items.push({ name, price, category });
        updateItemList();
      } else {
        alert('لطفاً نام و قیمت معتبر وارد کنید.');
      }
    }

    // تراکنش جدید
    function addTaskInput() {
      taskCount++;
      const taskList = document.getElementById('taskList');
      taskList.innerHTML += `
        <div class="task-input">
          <input type="text" id="taskDescription${taskCount}" placeholder="توضیح تراکنش" class="w-full p-2 border rounded mb-1" required />
          <input type="number" id="taskIncome${taskCount}" placeholder="درآمد (تومان)" class="w-full p-2 border rounded mb-1" required />
          <input type="number" id="taskExpense${taskCount}" placeholder="هزینه (تومان)" class="w-full p-2 border rounded mb-1" required />
          <button onclick="removeTaskInput(${taskCount})" class="btn w-full mt-1">حذف تراکنش</button>
        </div>`;
    }
    function removeTaskInput(index) {
      const taskDiv = document.getElementById(`taskDescription${index}`).parentElement;
      taskDiv.remove();
    }

    function saveDay() {
      const date = dateInput.value;
      if (!date) return alert('لطفاً تاریخ وارد کنید.');
      const partnerIndex = document.getElementById('partner').value;
      const itemIndex = document.getElementById('item').value;
      if (partnerIndex === '' || itemIndex === '') return alert('لطفاً همکار و جنس را انتخاب کنید');
      const partner = partnerIndex === '-1' ? { name: 'بدون همکار', salary: 0, totalPaid: 0, totalWorkedDays: 0 } : partners[partnerIndex];
      const item = itemIndex === '-1' ? { name: 'بدون جنس', price: 0 } : items[itemIndex];
      const dayTasks = [];
      for (let i = 0; i <= taskCount; i++) {
        const description = document.getElementById(`taskDescription${i}`)?.value || '';
        const income = parseInt(document.getElementById(`taskIncome${i}`)?.value) || 0;
        const expense = parseInt(document.getElementById(`taskExpense${i}`)?.value) || 0;
        if (description || income || expense) {
          const profit = income - expense;
          dayTasks.push({ description, income, expense, profit, paid: false });
        }
      }
      if (dayTasks.length > 0) {
        let dayIndex = tasks.findIndex(t => t.date === date);
        if (dayIndex !== -1) {
          tasks[dayIndex].tasks.push(...dayTasks);
        } else {
          tasks.push({ date, partner: partner.name, partnerSalary: partner.salary, item: item.name, itemPrice: item.price, tasks: dayTasks });
          if (partnerIndex !== '-1') partners[partnerIndex].totalWorkedDays += 1;
        }
        localStorage.setItem('tasks', JSON.stringify(tasks));
        if (partnerIndex !== '-1') localStorage.setItem('partners', JSON.stringify(partners));
        dayTasks.forEach(task => {
          if (task.income > 0 && !task.paid) {
            const existingCredit = credits.find(c => c.description === `${date} - ${task.description}` && c.amount === task.income);
            if (!existingCredit) {
              credits.push({ description: `${date} - ${task.description}`, amount: task.income });
              localStorage.setItem('credits', JSON.stringify(credits));
            }
          }
        });
        document.getElementById('taskList').innerHTML = `
          <div class="task-input">
            <input type="text" id="taskDescription0" placeholder="توضیح تراکنش" class="w-full p-2 border rounded mb-1" required />
            <input type="number" id="taskIncome0" placeholder="درآمد (تومان)" class="w-full p-2 border rounded mb-1" required />
            <input type="number" id="taskExpense0" placeholder="هزینه (تومان)" class="w-full p-2 border rounded mb-1" required />
          </div>`;
        taskCount = 0;
        updateAll();
      } else {
        alert('حداقل یک تراکنش را وارد کنید');
      }
    }

    // گزارش روزانه
    function showDailyReport() {
      const reportDiv = document.getElementById('dailyReportContent');
      const date = document.getElementById('dailyDate').value;
      const dayTasks = tasks.find(t => t.date === date);
      if (dayTasks) {
        reportDiv.innerHTML = `
          <table>
            <tr><th>مورد</th><th>جزئیات</th></tr>
            <tr><td>همکار</td><td>${dayTasks.partner}</td></tr>
            <tr><td>جنس</td><td>${dayTasks.item} - ${dayTasks.itemPrice.toLocaleString()} تومان</td></tr>
          </table>
          <table class="mt-2">
            <tr><th>توضیح</th><th>درآمد</th><th>هزینه</th><th>سود</th></tr>
            ${dayTasks.tasks.map(task => `
              <tr>
                <td>${task.description}</td>
                <td>${task.income.toLocaleString()}</td>
                <td>${task.expense.toLocaleString()}</td>
                <td>${task.profit.toLocaleString()}</td>
              </tr>
            `).join('')}
          </table>`;
      } else {
        reportDiv.innerHTML = '<p>هیچ تراکنشی برای این روز ثبت نشده.</p>';
      }
    }
    function showMonthlyReport() {
      const month = document.getElementById('monthlyDate').value;
      const filteredTasks = tasks.filter(t => t.date.startsWith(month));
      const reportDiv = document.getElementById('monthlyReportContent');
      if (filteredTasks.length > 0) {
        reportDiv.innerHTML = `
          <table>
            <tr><th>تاریخ</th><th>همکار</th><th>جنس</th><th>درآمد کل</th><th>هزینه کل</th><th>سود کل</th></tr>
            ${filteredTasks.map(t => `
              <tr>
                <td>${t.date}</td>
                <td>${t.partner}</td>
                <td>${t.item}</td>
                <td>${t.tasks.reduce((s, task) => s + task.income, 0).toLocaleString()}</td>
                <td>${t.tasks.reduce((s, task) => s + task.expense, 0).toLocaleString()}</td>
                <td>${t.tasks.reduce((s, task) => s + task.profit, 0).toLocaleString()}</td>
              </tr>
            `).join('')}
          </table>`;
      } else {
        reportDiv.innerHTML = '<p>هیچ تراکنشی برای این ماه ثبت نشده.</p>';
      }
    }
    function showAccounting() {
      const accountingDiv = document.getElementById('accountingContent');
      const year = document.getElementById('accountingDate').value;
      const filteredTasks = tasks.filter(t => t.date.startsWith(year));
      const totalIncome = filteredTasks.reduce((sum, t) => sum + t.tasks.reduce((s, task) => s + task.income, 0), 0);
      const totalExpense = filteredTasks.reduce((sum, t) => sum + t.tasks.reduce((s, task) => s + task.expense, 0), 0);
      const totalDebt = debts.reduce((sum, d) => sum + d.amount, 0);
      const totalCredit = credits.reduce((sum, c) => sum + c.amount, 0);
      const totalProfit = totalIncome - totalExpense - totalDebt + totalCredit;
      accountingDiv.innerHTML = `
        <table>
          <tr><th>مورد</th><th>جزئیات</th></tr>
          <tr><td>درآمد کل</td><td>${totalIncome.toLocaleString()} تومان</td></tr>
          <tr><td>هزینه کل</td><td>${totalExpense.toLocaleString()} تومان</td></tr>
          <tr><td>بدهی کل</td><td>${totalDebt.toLocaleString()} تومان</td></tr>
          <tr><td>طلب کل</td><td>${totalCredit.toLocaleString()} تومان</td></tr>
          <tr><td>سود خالص</td><td>${totalProfit.toLocaleString()} تومان</td></tr>
        </table>`;
    }
    function showDebt() {
      const debtDiv = document.getElementById('debtContent');
      let totalDebt = 0;
      partners.forEach(p => {
        const owed = (p.totalWorkedDays || 0) * p.salary - (p.totalPaid || 0);
        if (owed > 0) totalDebt += owed;
      });
      totalDebt += debts.reduce((sum, d) => sum + d.amount, 0);
      debtDiv.innerHTML = `
        <table>
          <tr><th>مورد</th><th>مبلغ</th></tr>
          <tr><td>بدهی کل به همکارها</td><td>${totalDebt.toLocaleString()} تومان</td></tr>
        </table>`;
    }
    function showCredit() {
      const creditDiv = document.getElementById('creditContent');
      const totalCredit = credits.reduce((sum, c) => sum + c.amount, 0);
      creditDiv.innerHTML = `
        <table>
          <tr><th>مورد</th><th>مبلغ</th></tr>
          <tr><td>طلب کل</td><td>${totalCredit.toLocaleString()} تومان</td></tr>
        </table>`;
    }
    function searchTasks() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const results = tasks.filter(task => {
        return task.date.toLowerCase().includes(query) ||
               task.item.toLowerCase().includes(query) ||
               task.partner.toLowerCase().includes(query) ||
               task.tasks.some(t => t.description.toLowerCase().includes(query));
      });
      const searchResults = document.getElementById('searchResults');
      if (!query) {
        searchResults.innerHTML = '<p>جستجو را شروع کنید...</p>';
        return;
      }
      if (results.length > 0) {
        searchResults.innerHTML = `
          <table>
            <tr><th>تاریخ</th><th>همکار</th><th>جنس</th><th>توضیحات</th><th>مبلغ کل</th></tr>
            ${results.map(t => {
              const totalAmount = t.tasks.reduce((sum, task) => sum + task.income - task.expense, 0);
              return `
                <tr>
                  <td>${t.date}</td>
                  <td>${t.partner}</td>
                  <td>${t.item}</td>
                  <td>${t.tasks.map(task => task.description).join(', ')}</td>
                  <td>${totalAmount.toLocaleString()} تومان</td>
                </tr>`;
            }).join('')}
          </table>`;
      } else {
        searchResults.innerHTML = '<p>هیچ تراکنشی یافت نشد.</p>';
      }
    }

    // بدهی/طلبکاری
    function addDebt() {
      const desc = document.getElementById('newDebtDescription').value;
      const amount = parseInt(document.getElementById('newDebtAmount').value);
      if (!desc || !amount) return alert('توضیح و مبلغ بدهی را وارد کنید');
      debts.push({ description: desc, amount });
      localStorage.setItem('debts', JSON.stringify(debts));
      document.getElementById('newDebtDescription').value = '';
      document.getElementById('newDebtAmount').value = '';
      showDebt();
    }
    function settleDebt() {
      const amount = parseInt(document.getElementById('settleDebtAmount').value);
      if (!amount) return alert('مبلغ را وارد کنید');
      let remaining = amount;
      debts = debts.reduce((arr, d) => {
        if (remaining <= 0) return arr.concat(d);
        if (d.amount <= remaining) {
          remaining -= d.amount;
          return arr;
        } else {
          d.amount -= remaining;
          remaining = 0;
          return arr.concat(d);
        }
      }, []);
      localStorage.setItem('debts', JSON.stringify(debts));
      document.getElementById('settleDebtAmount').value = '';
      showDebt();
    }
    function addCredit() {
      const desc = document.getElementById('newCreditDescription').value;
      const amount = parseInt(document.getElementById('newCreditAmount').value);
      if (!desc || !amount) return alert('توضیح و مبلغ طلب را وارد کنید');
      credits.push({ description: desc, amount });
      localStorage.setItem('credits', JSON.stringify(credits));
      document.getElementById('newCreditDescription').value = '';
      document.getElementById('newCreditAmount').value = '';
      showCredit();
    }
    function settleCredit() {
      const amount = parseInt(document.getElementById('settleCreditAmount').value);
      if (!amount) return alert('مبلغ را وارد کنید');
      let remaining = amount;
      credits = credits.reduce((arr, c) => {
        if (remaining <= 0) return arr.concat(c);
        if (c.amount <= remaining) {
          remaining -= c.amount;
          return arr;
        } else {
          c.amount -= remaining;
          remaining = 0;
          return arr.concat(c);
        }
      }, []);
      localStorage.setItem('credits', JSON.stringify(credits));
      document.getElementById('settleCreditAmount').value = '';
      showCredit();
    }

    // تاریخ‌ها
    function updateCustomDate(inputId) {
      const input = document.getElementById(inputId);
      const dateStr = input.value.trim();
      if (/^14\d{2}\/\d{2}\/\d{2}$/.test(dateStr)) input.value = dateStr;
      else input.value = window.jalaliMoment().format('jYYYY/jMM/jDD');
      updateAll();
    }
    function updateCustomMonth() {
      const input = document.getElementById('monthlyDate');
      const monthStr = input.value.trim();
      if (/^14\d{2}\/\d{2}$/.test(monthStr)) input.value = monthStr;
      else input.value = window.jalaliMoment().format('jYYYY/jMM');
      showMonthlyReport();
    }
    function updateCustomYear() {
      const input = document.getElementById('accountingDate');
      const yearStr = input.value.trim();
      if (/^14\d{2}$/.test(yearStr)) input.value = yearStr;
      else input.value = window.jalaliMoment().format('jYYYY');
      showAccounting();
    }
    function updateAll() {
      updatePartnerList();
      updateItemList();
      showDailyReport();
      showMonthlyReport();
      showAccounting();
      showDebt();
      showCredit();
      searchTasks();
    }

    updateAll();
    showTab('dailyReport');
  </script>
</body>
</html>
